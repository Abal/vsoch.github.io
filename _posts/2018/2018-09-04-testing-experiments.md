---
title: "Testing Reproducible Experiments"
date: 2018-09-06 3:20:00
toc: false
---
 
Web based experiments must be reproducible, but what does that mean? Typically,
a "best effort" might provide code on Github, and pre-register on the 
<a href="https://osf.io" target="_blank">open science framework</a>. 
This is a good start, but can we do better? For example, an open source project near and dear to me,
the <a href="https://expfactory.github.io" target="_blank">Experiment Factory</a>
places a lot of trust in the creator of the experiments. What is missing?

## Testing Reproducible Experiments

The fact that the individual experiments aren't **tested**, **deployed**, and **archived**
 is problematic. If I were to install from Github
today and build into a container, that's great. But what if someone else wants to use
a previous version of the experiment? With Github it isn't _impossible_, but as you move further
away from "the thing that I'm actually using" to "scripts run in some place that no longer exists
to generate the thing" the probability of success decreases. What would be an improvement? 
I would want the following things:

<ol class="custom-counter">
<li><strong>Automation</strong> to build a container to deploy the experiment</li>
<li><strong>Software</strong> or functions for working with results</li>
<li><strong>Testing</strong> for the experiment and any analysis software</li>
<li>A versioned <strong>archive</strong> of metadata and manifests</li>
<li>A live <strong>preview</strong> of the current version</li>
</ol>

> Is this too much to ask?

I don't think so! 

### Where does all this stuff go?

It belongs with the experiment. Each experiment should provide its own
reproducible testing, development, and sharing, because The Experiment Factory itself
cannot take on the burden of doing this at every level. 


### Who is responsible for doing this?

There is no single person better optimized to write (and provide) code for doing things like processing
the results or testing the experiment software than the creator of it, **not** a user
that starts at a step 1 of "What's going on?" But we must separate the actual functions and
experiment from the supporting infrastructure. The ability to plug into a testing system and
configure deployment should not be something that the creator needs to worry about.

This point was the start of my thinking, and 
that while each individual component in the list above might be easy to set up, getting them
all together would sum to quite a bit of work. How can we make this easier? Today I want to discuss
the start of this work by talking about the steps involved. I'm going to be giving a quick overview of the 
following two experiments:

 - [The Breath Counting Task](#example-1-the-breath-counting-task)
 - [The N-back 10 Minute Animals](#example-2-the-back-10min-animals)
 - [Final Thoughts on Templates](#templates-are-important)

<br>

I challenged my colleagues <a href="http://github.com/earcanal" target="_blank">@earcanal</a> and
<a href="http://github.com/tylerburleigh" target="_blank">@tylerburleigh</a> to stick with me as
we went on an adventure of Github, CircleCI, R package creation and testing, headless browser drivers,
and back! 

<br>

# Example 1: The Breath Counting Task

Earlier this week my colleague <a href="http://github.com/earcanal" target="_blank">@earcanal</a> and I
finally chiseled together a complete workflow that I've wanted for quite some time.
 We put together what I would consider the start of my definition 
for a tested reproducible experiment. Yes, there are improvements to make, but the duct taped
thing has taken shape! And it's a beautiful beastie.

### The Workflow Setup

The magic happens with Github and CircleCI, just like this. We start with a 
<a href="https://github.com/expfactory-experiments/breath-counting-task" target="_blank">Github
repository</a>

<div>
<img src="/assets/images/posts/breath-counting-task/github.png" style="padding-top:20px; padding-bottom:20px">
</div>

and notice within the repository we have static files for the experiment,
along with a folder (`expfactory.breathcounting`) that has a package generated by @earcanal
that is functions to work with data generated by this experiment. We then hook it into a continuous integration
service, here is the workflow on <a href="https://circleci.com/workflow-run/65bb8268-b564-40ad-81a7-10cb5b42cdcf">CircleCI</a>

<div>
<img src="/assets/images/posts/breath-counting-task/circleci.png" style="padding-top:20px; padding-bottom:20px">
</div>

### Testing Software

If it's a pull request, we are primarily interested with running the library of tests. Here are tests run by the
<a href="https://github.com/expfactory/expfactoryr" target="_blank">expfactoryr</a> library to test the Breath Counting
Task's own library. Note that we do this via a <a href="https://hub.docker.com/r/expfactory/expfactoryr/" target="_blank">Docker Container</a>.

<br>
<div>
<img src="/assets/images/posts/breath-counting-task/rtests.png" style="padding-top:20px; padding-bottom:20px">
</div>


And if the tests pass, we use the <a href="https://hub.docker.com/r/vanessa/expfactory-builder/" target="_blank">expfactory-builder</a> to generate our experiment container!

<div>
<img src="/assets/images/posts/breath-counting-task/build.png" style="padding-top:20px; padding-bottom:20px">
</div>


### Reproducible Experiment

And then guess what? We push this new container to Docker Hub, where it's immediately available for your use.

<div>
<img src="/assets/images/posts/breath-counting-task/docker-hub.png" style="padding-top:20px; padding-bottom:20px">
</div>


Try it out yourself!

```bash

$ docker run -p 80:80 expfactory/breath-counting-task start

```

<br>

and open your browser to `http://127.0.0.1` (a.k.a "localhost") and there it is!

<div>
<img src="/assets/images/posts/breath-counting-task/browser.png" style="padding-top:20px; padding-bottom:20px">
</div>

<br>

That container is ready to go to <a href="https://expfactory.github.io/generate#start-your-container" target="_blank"> be deployed
in many different contexts</a>, and since the experiment is provided in the <a href="https://expfactory.github.io/experiments" target="_blank">library</a> it's also ready to go to build into a custom container (if you wanted to serve more than one experiment). You would then build and provide your container, just as we've done for the Breathe Counting Task. Cool :)

But that isn't what I'm most excited about. Remember the package that we built? And what about the container we just used?
Complete metadata (the container image manifest and the libraries and versions installed) are generated and sent
back to the <a href="https://github.com/expfactory-experiments/breath-counting-task/tree/gh-pages" target="_blank">
Github Pages branch</a>.

<br>

<div>
<img src="/assets/images/posts/breath-counting-task/ghpages.png" style="padding-top:20px; padding-bottom:20px">
</div>

<br>

# Example 2: The N-Back 10 Minute Animals

My colleague <a href="http://github.com/tylerburleigh" target="_blank">@tylerburleigh</a> is 
doing <a href="https://osf.io/nzm2g/drafts/5b8d56f1cc53a9001735a15b/register">some work</a>
 to access if shorter versions of some of our favorite paradigms can be used in place of the
longer versions. This one, "N-Back 10 Minute Animals" is one of my favorite because of this:

<div>
<img src="/assets/images/posts/breath-counting-task/nback.png" style="padding-top:20px; padding-bottom:20px">
</div>


Those icons are beautiful. This, along with the "Breath Counting Task" were the first
two for which I finally chiseled together a complete workflow that I've wanted for quite some time. 
We put together what I would consider the start of my definition 
for a tested reproducible experiment. Yes, there are improvements to make, but the duct taped
thing has taken shape! And it's a beautiful beastie.

### The Workflow Setup

As we did previously, we also start with a 
<a href="https://github.com/expfactory-experiments/nback-10min-animals" target="_blank">Github
repository</a>

<br>

<div>
<img src="/assets/images/posts/breath-counting-task/github-nback.png" style="padding-top:20px; padding-bottom:20px">
</div>

<br>

There is equivalently an R package for the researcher to use to process data, and we can see the experiment static files that are rendered on Github Pages for the experiment preview.

<br>

<div>
<img src="/assets/images/posts/breath-counting-task/preview.png" style="padding-top:20px; padding-bottom:20px">
</div>

<br>

And this package is equivalently tested with 
<a href="https://hub.docker.com/r/expfactory/expfactoryr/" target="_blank">expfactoryr</a> in the CircleCI workflow.
But now we have something different! What about testing the experiment itself? 
Since this is a <a href="https://www.jspsych.org/" target="_blank">JsPsych</a>
experiment, we have a <a href="https://github.com/expfactory/expfactory-robots" target="_blank">robot</a>
that then starts and proceeds through the experiment. He primarily ensures that we are able to go from
start to end, and there are no 404s or similar. This is done using
<a href="https://selenium-python.readthedocs.io/getting-started.html" target="_blank"> selenium</a> 
in Python and Chrome+geckodriver.

<div>
<img src="/assets/images/posts/breath-counting-task/robot.png" style="padding-top:20px; padding-bottom:20px">
</div>

Then if **both** sets of the tests pass, we use the <a href="https://hub.docker.com/r/vanessa/expfactory-builder/" target="_blank">expfactory-builder</a> to generate our experiment container, just as before, and it gets pushed
to <a href="https://hub.docker.com/r/expfactory/nback-10min-animals/" target="_blank">Docker Hub</a>,
and it's metadata and manifests generated and put back on <a href="https://github.com/expfactory-experiments/nback-10min-animals/tree/gh-pages" target="_blank">Github pages</a>. Here are some quick examples of what is generated:

 - [Inspection of Packages, Files](https://raw.githubusercontent.com/expfactory-experiments/nback-10min-animals/gh-pages/inspect-d5b2a9625a.json)
 - [Image Manifest](https://github.com/expfactory-experiments/nback-10min-animals/blob/gh-pages/manifest-d5b2a9625a.json)


<br>

While it's not rendered (the master branch is used to serve the task in the repository) there is also a 
<a href="https://github.com/expfactory-experiments/nback-10min-animals/blob/gh-pages/index.html" target="_blank">table index.html</a> file. This means that you can drop the entire `gh-pages` branch into a web root and get a nice site to explore
container links, and metadata. It looks like <a href="https://vsoch.github.io/repo2docker-keras/">this one</a>. And of course to  test out task container:

```bash

$ docker run -p 80:80 expfactory/nback-10min-animals start

```

<br>

# Templates are Important

I probably sound like a broken record, but this simple setup of having code in version control, testing and deploying, and keeping
some important outputs or even interactive web content? There are endless many use cases! The exciting thing is
that while these initial bases can be a lot to create, once you have your template? It is **so** easy to hand to someone else and they get the same beautiful thing. As a developer, I've gone from a mindset of

> How do I create a new tool to do the thing

to

> How can I made it easier to use already existing things?

And this means that the <span style="color:green">currency</span> that I want to operate is on the level of webhooks (services) and modular templates to use them. It makes sense, right? 

### What I'm thinking about

It's essential that researchers and developers are able to achieve something similar to this with
very little work. The above is just a start. From the above, the following needs more work:


**Checklists**

They work for flying airplanes, and they work here too! Each template needs a checklist of things to do to go from
I'm just a template" to "I'm sign, sealed, and delivered!" A first shot at this is adding a <a href="https://github.com/expfactory-experiments/nback-10min-animals/blob/master/.github/ISSUE_TEMPLATE/deploy-checklist-experiment.md" target="_blank">Github Issue Template</a> so a user could keep track of their progress filling in the template, and close the issue when finished.
If I had an automated way for the user to fork some template repository to "fill in" I would create this
issue and direct them to it. Also notice that the template is specific to an "experiment." I would want to have
a selection of different issue templates to provide based on the needs of the template.


**Modular Github Pages**

It's fairly straight forward to deploy a single thing to Github pages like a set of manifests or a rendered PDF. But what 
happens when you put together components of some template like blocks? Then what if each of those blocks has it's own
version of an "index.html" and you either have to merge them or only choose one? I ran into this issue when
I realized I couldn't deploy my table of manifests because the experiment preview was already rendered there.
We need to define an organizational structure for the Github Pages content that is generated so we can have certainty that some
set of rendered outputs each has a consistent place to live.


**Badges**

We need to understand what constitutes a template. In the above, we had experiments, a specific testing robot,
a testing package in R, and deployment to Docker Hub. I need to be able to look at the Github repository and
both identify the template, and the things that make it up. "Badges" can solve this in a fun way, because they
come down to categories.

<br>

# Thanks for stopping by! 

If you can't tell, I'm really excited about this development, and I think it's
going to produce something that is both fun and useful. Over here in dinosaur land there are a few projects 
underway around this idea, so I'm excited to share those with you when the time is right. :)


## Resources

 - [Github](https://github.com/expfactory-experiments/breath-counting-task)
 - [Docker Hub](https://hub.docker.com/r/expfactory/breath-counting-task/)
 - [Experiment Preview](https://expfactory-experiments.github.io/breath-counting-task/)
 - [Metadata and Package](https://github.com/expfactory-experiments/breath-counting-task/tree/gh-pages)
 - [The Experiment Factory](https://expfactory.github.io)
 - [Expfactory Experiments](https://github.com/expfactory-experiments)
